<html>
<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
  </head>
  <body>
    <!-- Note the usage of `type=module` here as this is an ES6 module -->
    <script src='audioBufferToWav.js'></script>
    <script type="module">
      import init, { Image, init_panic_hook, image_to_audio, Audio } from './pkg/rs_imgwav.js';

      async function run() {
        await init();
        init_panic_hook();

        const canvas = document.getElementById('canvas');
        const canvasCtx = canvas.getContext('2d');
        let source_image = document.getElementById('source_image');
        canvas.height = source_image.height;
        canvas.width = source_image.width;
        canvasCtx.drawImage(source_image, 0, 0);
        let imgData = canvasCtx.getImageData(0, 0, source_image.width, source_image.height);
        let sampleRate = 44100;
        let audio = image_to_audio(imgData.data, imgData.width, imgData.height, sampleRate);
        let samples = audio.samples();
        let audioCtx = new AudioContext();
        let buffer = audioCtx.createBuffer(1, samples.length, audio.sample_rate);
        buffer.copyToChannel(samples, 0, 0);
        let wavBlob = new Blob([audioBufferToWav(buffer)], {type: 'audio/wav'});
        let blobUrl = URL.createObjectURL(wavBlob);
        let link = document.createElement('a');
        link.href = blobUrl;
        link.download = 'audio.wav';
        link.innerHTML = 'download';
        document.body.appendChild(link);

        let img = Image.new(imgData.data, imgData.width, imgData.height);
        img.pad_top(50);
        img.invert();
        img.rotate90();
        img.reflect_about_y_axis();
        let clamped = new Uint8ClampedArray(img.rgba_data());
        imgData = new ImageData(clamped, img.width, img.height);
        canvas.height = img.height;
        canvas.width = img.width;
        canvasCtx.putImageData(imgData, 0, 0);
      }

      run();
    </script>
    <canvas id="canvas"></canvas>
    <img id="source_image" src="avocat.png">
  </body>
</html>
